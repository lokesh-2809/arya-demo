version: 2.1

orbs:
  node: circleci/node@5

jobs:
  test-node:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run tests
          command: echo "No tests defined"

  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - add_ssh_keys:
          fingerprints:
            - "SHA256:asOG2RzLEMrW/aakiDr/z4qUm0OQ/FCxXBLd8paFyls"  # Replace with actual fingerprint
      - run:
          name: Deploy with Docker
          command: |
            ssh -o StrictHostKeyChecking=no ec2-user@13.201.20.162 \<< EOF
              cd /home/ec2-user/arya-pulses   # Update path if different
              git pull origin main
              docker-compose down
              docker-compose build
              docker-compose up -d
            EOF

workflows:
  build-and-deploy:
    jobs:
      - test-node
      - deploy:
          requires:
            - test-node
          filters:
            branches:
              only: main
